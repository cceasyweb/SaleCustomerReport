<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Dashboard - ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á SCR</title>
    
    <!-- Library React + Tailwind -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style> 
        body { font-family: 'Prompt', sans-serif; } 
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        th { white-space: nowrap; }
        td { white-space: nowrap; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    
    <div id="root">
        <div style="text-align: center; padding: 50px; color: #666;">
            <h2 style="font-size: 24px;">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°...</h2>
            <div id="error-box" style="display:none; margin-top: 20px; padding: 15px; background: #fee2e2; border: 1px solid #ef4444; color: #b91c1c; text-align: left; border-radius: 8px; max-width: 800px; margin: 20px auto;">
                <h3 style="font-weight: bold;">‚ö†Ô∏è ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:</h3>
                <div id="error-msg" style="margin-top:10px; font-family: monospace; white-space: pre-wrap;"></div>
            </div>
        </div>
    </div>

    <!-- Script ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏±‡∏Å‡∏à‡∏±‡∏ö Error ‡πÉ‡∏ô Console ‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            var errorBox = document.getElementById('error-box');
            var errorMsg = document.getElementById('error-msg');
            if (errorBox && errorMsg) {
                errorBox.style.display = 'block';
                errorMsg.innerHTML += "‚ùå " + msg + "\nüìç Line: " + line + "\n\n";
            }
            return false;
        };
    </script>

    <script type="text/babel">
        // ************************************************************
        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
        // ************************************************************
        const API_BASE_URL = ''; 
        // ************************************************************

        const { useState, useMemo, useEffect } = React;

        const App = () => {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [filters, setFilters] = useState({ customer: '', product: '', group: '', brand: '', startDate: '', endDate: '' });

            const fetchData = async () => {
                setLoading(true);
                setError(null);
                try {
                    const apiUrl = `${window.location.origin}/api/sales`;
                    console.log("Connecting to:", apiUrl);
                    const response = await fetch(apiUrl);
                    if (!response.ok) {
                        const text = await response.text();
                        throw new Error(`Server Error (${response.status}): ${text.slice(0, 100)}`);
                    }
                    const result = await response.json();
                    if (!Array.isArray(result)) throw new Error("‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                    setData(result);
                } catch (err) {
                    console.error("Fetch Error:", err);
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => { fetchData(); }, []);

            const groupOptions = useMemo(() => [...new Set(data.map(item => item.group || '-'))].sort(), [data]);
            const brandOptions = useMemo(() => [...new Set(data.map(item => item.brand || '-'))].sort(), [data]);

            const handleFilterChange = (e) => setFilters(prev => ({ ...prev, [e.target.name]: e.target.value }));
            const resetFilters = () => setFilters({ customer: '', product: '', group: '', brand: '', startDate: '', endDate: '' });

            const filteredData = useMemo(() => {
                return data.filter(item => {
                    const matchCustomer = (item.customer || '').toLowerCase().includes(filters.customer.toLowerCase());
                    const matchProduct = (item.productName || '').toLowerCase().includes(filters.product.toLowerCase()) || 
                                         String(item.productCode || "").toLowerCase().includes(filters.product.toLowerCase()) ||
                                         String(item.barcode || "").toLowerCase().includes(filters.product.toLowerCase()); 
                    const matchGroup = filters.group ? item.group === filters.group : true;
                    const matchBrand = filters.brand ? item.brand === filters.brand : true;
                    let matchDate = true;
                    if (filters.startDate && filters.endDate) matchDate = item.date >= filters.startDate && item.date <= filters.endDate;
                    else if (filters.startDate) matchDate = item.date >= filters.startDate;
                    else if (filters.endDate) matchDate = item.date <= filters.endDate;
                    return matchCustomer && matchProduct && matchGroup && matchBrand && matchDate;
                });
            }, [data, filters]);

            const grandTotal = filteredData.reduce((acc, item) => acc + (item.total || 0), 0);

            const exportToExcel = () => {
                const headers = ["‡∏™‡∏≤‡∏Ç‡∏≤", "Doc No.", "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£", "‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", "‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", "‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πä‡∏î", "‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", "‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", "‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô", "‡∏´‡∏ô‡πà‡∏ß‡∏¢", "‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢(‡∏™‡∏∏‡∏ó‡∏ò‡∏¥)", "‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥"];
                const csvContent = [
                    headers.join(","),
                    ...filteredData.map(item => [
                        `"${item.branch || ''}"`,
                        `"${item.docNo || ''}"`,
                        `"${item.billNo || ''}"`,
                        `"${item.customer || ''}"`,
                        `"${item.productCode || ''}"`,
                        `"${item.barcode || ''}"`,
                        `"${item.productName || ''}"`,
                        `"${item.group || ''}"`,
                        `"${item.brand || ''}"`,
                        item.qty || 0,
                        `"${item.unit || ''}"`,
                        (item.price || 0).toFixed(2),
                        (item.total || 0).toFixed(2)
                    ].join(","))
                ].join("\n");
                const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a"); link.setAttribute("href", url); 
                link.setAttribute("download", `Sales_Report_SCR_${new Date().toISOString().slice(0,10)}.csv`);
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
            };

            return (
                <div className="min-h-screen p-4 md:p-6 bg-slate-100 font-sans text-slate-800">
                    <div className="w-full mx-auto space-y-6">
                        <header className="bg-white rounded-xl p-5 shadow-sm border border-slate-200 flex flex-col md:flex-row justify-between items-center gap-4">
                            <div>
                                <h1 className="text-2xl font-bold text-slate-800">Sales Dashboard (New SCR)</h1>
                                <div className="text-sm text-slate-500 mt-1">
                                    <span className={`inline-block w-2 h-2 rounded-full mr-2 ${error ? 'bg-red-500' : 'bg-green-500'}`}></span>
                                    {loading ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...' : error ? error : `Online: ${filteredData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`}
                                </div>
                            </div>
                            <div className="flex gap-4 items-center">
                                <div className="text-right hidden md:block bg-slate-50 px-4 py-2 rounded-lg border border-slate-100">
                                    <div className="text-[10px] text-slate-400 font-bold uppercase tracking-wider">‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</div>
                                    <div className="text-xl font-bold text-blue-600">‡∏ø {grandTotal.toLocaleString(undefined, {minimumFractionDigits: 2})}</div>
                                </div>
                                <button onClick={exportToExcel} className="bg-green-600 hover:bg-green-700 text-white px-5 py-2.5 rounded-lg shadow-sm font-medium flex items-center gap-2">Export Excel</button>
                            </div>
                        </header>

                        <section className="bg-white rounded-xl shadow-sm p-5 border border-slate-200">
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                                <div className="lg:col-span-1"><input type="date" name="startDate" onChange={handleFilterChange} className="w-full border p-2 rounded text-sm" placeholder="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°" /></div>
                                <div><input type="text" name="customer" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤..." onChange={handleFilterChange} className="w-full border p-2 rounded text-sm" /></div>
                                <div><input type="text" name="product" placeholder="‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏£‡∏´‡∏±‡∏™/‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î..." onChange={handleFilterChange} className="w-full border p-2 rounded text-sm" /></div>
                                <div className="flex gap-2">
                                    <select name="group" onChange={handleFilterChange} className="w-full border p-2 rounded text-sm"><option value="">‡∏ó‡∏∏‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°</option>{groupOptions.map(g => <option key={g} value={g}>{g}</option>)}</select>
                                    <select name="brand" onChange={handleFilterChange} className="w-full border p-2 rounded text-sm"><option value="">‡∏ó‡∏∏‡∏Å‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠</option>{brandOptions.map(b => <option key={b} value={b}>{b}</option>)}</select>
                                </div>
                                <div><button onClick={resetFilters} className="text-red-500 border border-red-200 w-full py-2 rounded text-sm hover:bg-red-50">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤</button></div>
                            </div>
                        </section>

                        <section className="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden overflow-x-auto">
                            <table className="w-full text-sm text-left whitespace-nowrap">
                                <thead className="bg-slate-50 border-b border-slate-200 text-slate-600 font-semibold text-xs uppercase tracking-wider">
                                    <tr>
                                        <th className="px-4 py-3 text-center">‡∏™‡∏≤‡∏Ç‡∏≤</th>
                                        <th className="px-4 py-3 text-left border-l border-slate-100">Doc No.</th>
                                        <th className="px-4 py-3 text-left border-l border-slate-100">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</th>
                                        <th className="px-4 py-3 text-left border-l border-slate-100">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                                        <th className="px-4 py-3 text-left border-l border-slate-100">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                        <th className="px-4 py-3 text-left border-l border-slate-100">‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πä‡∏î</th>
                                        <th className="px-4 py-3 text-left border-l border-slate-100">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                        <th className="px-4 py-3 text-left border-l border-slate-100">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                        <th className="px-4 py-3 text-left border-l border-slate-100">‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                        <th className="px-4 py-3 text-right border-l border-slate-100">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                                        <th className="px-4 py-3 text-center border-l border-slate-100">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                                        <th className="px-4 py-3 text-right border-l border-slate-100">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢(‡∏™‡∏∏‡∏ó‡∏ò‡∏¥)</th>
                                        <th className="px-4 py-3 text-right border-l border-slate-100 bg-slate-100 font-bold">‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {loading ? <tr><td colSpan="13" className="text-center py-10 text-slate-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr> : 
                                     filteredData.length === 0 ? <tr><td colSpan="13" className="text-center py-10 text-slate-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr> :
                                     filteredData.map((item, idx) => (
                                        <tr key={idx} className="hover:bg-blue-50 transition-colors">
                                            <td className="px-4 py-3 text-center">{item.branch}</td>
                                            <td className="px-4 py-3 text-left border-l border-slate-100">{item.docNo}</td>
                                            <td className="px-4 py-3 text-left border-l border-slate-100 text-blue-600 font-mono text-xs">{item.billNo}</td>
                                            <td className="px-4 py-3 text-left border-l border-slate-100 truncate max-w-[150px]" title={item.customer}>{item.customer}</td>
                                            <td className="px-4 py-3 text-left border-l border-slate-100 font-mono text-xs">{item.productCode}</td>
                                            <td className="px-4 py-3 text-left border-l border-slate-100 font-mono text-xs text-purple-600">{item.barcode}</td>
                                            <td className="px-4 py-3 text-left border-l border-slate-100 truncate max-w-[200px]" title={item.productName}>{item.productName}</td>
                                            <td className="px-4 py-3 text-left border-l border-slate-100 text-xs text-slate-500">{item.group}</td>
                                            <td className="px-4 py-3 text-left border-l border-slate-100 text-xs text-slate-500">{item.brand}</td>
                                            <td className="px-4 py-3 text-right border-l border-slate-100 font-medium">{item.qty.toLocaleString()}</td>
                                            <td className="px-4 py-3 text-center border-l border-slate-100 text-xs">{item.unit}</td>
                                            <td className="px-4 py-3 text-right border-l border-slate-100 text-slate-600">{item.price.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
                                            <td className="px-4 py-3 text-right border-l border-slate-100 font-bold text-slate-800 bg-slate-50">{item.total.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </section>
                    </div>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
